name: ğŸ›¡ï¸ Quality Gate - Zero Error Deployment

on:
  push:
    branches: [ main, develop, fix/* ]
  pull_request:
    branches: [ main, develop ]

jobs:
  quality-gate:
    name: ğŸ” Quality Gate Validation
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: ğŸ” Validate Project Structure
      run: |
        echo "ğŸ” Checking required files..."
        
        # Check essential files
        if [ ! -f "package.json" ]; then
          echo "âŒ ERROR: package.json missing"
          exit 1
        fi
        
        if [ ! -f "app/page.jsx" ]; then
          echo "âŒ ERROR: app/page.jsx missing"
          exit 1
        fi
        
        if [ ! -f "app/layout.jsx" ]; then
          echo "âŒ ERROR: app/layout.jsx missing"
          exit 1
        fi
        
        # Check forbidden directories
        if [ -d "app/blobs" ]; then
          echo "âŒ ERROR: app/blobs directory found - should be removed"
          exit 1
        fi
        
        if [ -d "app/image-cdn" ]; then
          echo "âŒ ERROR: app/image-cdn directory found - should be removed"
          exit 1
        fi
        
        echo "âœ… Project structure validation PASSED"
        
    - name: ğŸ” Scan for Problematic Dependencies
      run: |
        echo "ğŸ” Scanning for problematic packages..."
        
        # Check package.json for forbidden dependencies
        FORBIDDEN_DEPS=("blobshape" "@netlify/blobs" "unique-names-generator")
        
        for dep in "${FORBIDDEN_DEPS[@]}"; do
          if grep -q "\"$dep\"" package.json; then
            echo "âŒ ERROR: Forbidden dependency found: $dep"
            exit 1
          fi
        done
        
        echo "âœ… Dependency scan PASSED"
        
    - name: ğŸ” Validate Import Paths
      run: |
        echo "ğŸ” Validating import paths..."
        
        # Check for problematic imports in JS/JSX files
        PROBLEMATIC_IMPORTS=(
          "'../utils.js'"
          "'components/dashboard-preview'"
          "'blobshape'"
          "'@netlify/blobs'"
          "'unique-names-generator'"
        )
        
        for import in "${PROBLEMATIC_IMPORTS[@]}"; do
          if find . -name "*.js" -o -name "*.jsx" -o -name "*.ts" -o -name "*.tsx" | xargs grep -l "$import" 2>/dev/null; then
            echo "âŒ ERROR: Problematic import found: $import"
            echo "Files containing this import:"
            find . -name "*.js" -o -name "*.jsx" -o -name "*.ts" -o -name "*.tsx" | xargs grep -l "$import"
            exit 1
          fi
        done
        
        echo "âœ… Import validation PASSED"
        
    - name: ğŸ“¦ Install dependencies
      run: |
        echo "ğŸ“¦ Installing dependencies..."
        npm ci
        echo "âœ… Dependencies installed successfully"
        
    - name: ğŸ—ï¸ Test Build
      run: |
        echo "ğŸ—ï¸ Testing build process..."
        npm run build
        echo "âœ… Build test PASSED"
        
    - name: ğŸ§ª Run Tests (if available)
      run: |
        if [ -f "package.json" ] && grep -q '"test"' package.json; then
          echo "ğŸ§ª Running tests..."
          npm test -- --passWithNoTests
        else
          echo "â„¹ï¸ No tests configured, skipping..."
        fi
        
    - name: âœ… Quality Gate PASSED
      run: |
        echo "ğŸ‰ =========================================="
        echo "ğŸ‰ QUALITY GATE VALIDATION SUCCESSFUL!"
        echo "ğŸ‰ =========================================="
        echo "âœ… Project structure: VALID"
        echo "âœ… Dependencies: CLEAN"
        echo "âœ… Imports: VALID"
        echo "âœ… Build: SUCCESSFUL"
        echo "ğŸš€ DEPLOYMENT AUTHORIZED!"
        
  notify-success:
    name: ğŸ“¢ Success Notification
    runs-on: ubuntu-latest
    needs: quality-gate
    if: success()
    
    steps:
    - name: ğŸ‰ Deployment Ready
      run: |
        echo "ğŸ¯ QUALITY GATE PASSED - DEPLOYMENT READY!"
        echo "ğŸ›¡ï¸ Zero Error Deployment System: ACTIVE"
        echo "ğŸ“Š SAPience ML Platform: VALIDATED"