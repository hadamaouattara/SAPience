name: ğŸ“Š Health Monitor - Post Deployment Validation

on:
  workflow_run:
    workflows: ["ğŸ›¡ï¸ Quality Gate - Zero Error Deployment"]
    types:
      - completed
  schedule:
    # Run health check every 6 hours
    - cron: '0 */6 * * *'
  workflow_dispatch:
    # Allow manual trigger

jobs:
  health-monitor:
    name: ğŸ¥ System Health Check
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'schedule' || github.event_name == 'workflow_dispatch' }}
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: ğŸ” Deep Structure Validation
      run: |
        echo "ğŸ” Performing deep structure validation..."
        
        # Verify critical app structure
        REQUIRED_FILES=(
          "app/page.jsx"
          "app/layout.jsx" 
          "package.json"
          "next.config.js"
          ".github/workflows/quality-gate.yml"
        )
        
        for file in "${REQUIRED_FILES[@]}"; do
          if [ ! -f "$file" ]; then
            echo "âŒ CRITICAL: Missing file $file"
            exit 1
          else
            echo "âœ… Found: $file"
          fi
        done
        
        # Verify forbidden directories stay removed
        FORBIDDEN_DIRS=("app/blobs" "app/image-cdn")
        
        for dir in "${FORBIDDEN_DIRS[@]}"; do
          if [ -d "$dir" ]; then
            echo "âŒ CRITICAL: Forbidden directory returned: $dir"
            exit 1
          else
            echo "âœ… Confirmed removed: $dir"
          fi
        done
        
        echo "âœ… Deep structure validation PASSED"
        
    - name: ğŸ” Dependencies Health Check
      run: |
        echo "ğŸ” Checking dependencies health..."
        
        # Install and verify dependencies
        npm ci
        
        # Check for security vulnerabilities
        if command -v npm audit &> /dev/null; then
          echo "ğŸ”’ Running security audit..."
          npm audit --audit-level moderate
        fi
        
        # Verify no forbidden packages
        FORBIDDEN_PACKAGES=("blobshape" "@netlify/blobs" "unique-names-generator")
        
        for package in "${FORBIDDEN_PACKAGES[@]}"; do
          if npm list "$package" &> /dev/null; then
            echo "âŒ CRITICAL: Forbidden package found: $package"
            exit 1
          fi
        done
        
        echo "âœ… Dependencies health check PASSED"
        
    - name: ğŸ—ï¸ Build Integrity Test
      run: |
        echo "ğŸ—ï¸ Testing build integrity..."
        
        # Clean build test
        rm -rf .next
        npm run build
        
        # Verify build output
        if [ ! -d ".next" ]; then
          echo "âŒ CRITICAL: Build failed - no .next directory"
          exit 1
        fi
        
        # Check for build errors in output
        if [ -f ".next/build-manifest.json" ]; then
          echo "âœ… Build manifest created successfully"
        else
          echo "âŒ WARNING: Build manifest missing"
        fi
        
        echo "âœ… Build integrity test PASSED"
        
    - name: ğŸ“Š Generate Health Report
      run: |
        echo "ğŸ“Š Generating system health report..."
        
        # Collect system metrics
        echo "=== SAPience ML Platform Health Report ==="
        echo "Date: $(date)"
        echo "Commit: $GITHUB_SHA"
        echo "Branch: $GITHUB_REF_NAME"
        echo ""
        
        echo "ğŸ“ Project Structure: âœ… HEALTHY"
        echo "ğŸ“¦ Dependencies: âœ… CLEAN"
        echo "ğŸ—ï¸ Build System: âœ… OPERATIONAL"
        echo "ğŸ›¡ï¸ Quality Gate: âœ… ACTIVE"
        echo ""
        
        # File counts
        echo "ğŸ“Š Metrics:"
        echo "- JavaScript files: $(find . -name "*.js" -not -path "./node_modules/*" | wc -l)"
        echo "- JSX files: $(find . -name "*.jsx" -not -path "./node_modules/*" | wc -l)"
        echo "- TypeScript files: $(find . -name "*.ts" -not -path "./node_modules/*" | wc -l)"
        echo "- TSX files: $(find . -name "*.tsx" -not -path "./node_modules/*" | wc -l)"
        echo ""
        
        echo "ğŸ¯ Status: SYSTEM HEALTHY âœ…"
        echo "ğŸš€ Deployment: SAFE TO PROCEED âœ…"
        
    - name: ğŸš¨ Alert on Failure
      if: failure()
      run: |
        echo "ğŸš¨ =========================================="
        echo "ğŸš¨ HEALTH CHECK FAILED!"
        echo "ğŸš¨ =========================================="
        echo "âŒ System integrity compromised"
        echo "âŒ Immediate attention required"
        echo "âŒ Deployment should be halted"
        echo ""
        echo "ğŸ“§ Please check the logs above for details"
        echo "ğŸ”§ Fix issues before proceeding"
        
  performance-check:
    name: âš¡ Performance Validation
    runs-on: ubuntu-latest
    needs: health-monitor
    if: success()
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: âš¡ Performance Tests
      run: |
        echo "âš¡ Running performance validation..."
        
        # Install dependencies
        npm ci
        
        # Build with performance monitoring
        echo "ğŸ—ï¸ Building with performance monitoring..."
        time npm run build
        
        # Check build size
        if [ -d ".next" ]; then
          BUILD_SIZE=$(du -sh .next | cut -f1)
          echo "ğŸ“¦ Build size: $BUILD_SIZE"
          
          # Simple size check (warn if over 100MB)
          SIZE_BYTES=$(du -sb .next | cut -f1)
          if [ "$SIZE_BYTES" -gt 104857600 ]; then
            echo "âš ï¸ WARNING: Build size is large (>100MB)"
          else
            echo "âœ… Build size is optimal"
          fi
        fi
        
        echo "âœ… Performance validation PASSED"
        
  security-scan:
    name: ğŸ”’ Security Validation
    runs-on: ubuntu-latest
    needs: health-monitor
    if: success()
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ”’ Security Scan
      run: |
        echo "ğŸ”’ Running security validation..."
        
        # Check for sensitive files
        SENSITIVE_PATTERNS=(".env" "*.key" "*.pem" "password" "secret")
        
        for pattern in "${SENSITIVE_PATTERNS[@]}"; do
          if find . -name "$pattern" -not -path "./node_modules/*" -not -name ".env.example" | grep -q .; then
            echo "âš ï¸ WARNING: Potential sensitive file found: $pattern"
          fi
        done
        
        # Check for hardcoded secrets in code
        echo "ğŸ” Scanning for hardcoded secrets..."
        if grep -r -i "password\|secret\|token\|key" --include="*.js" --include="*.jsx" --include="*.ts" --include="*.tsx" . | grep -v node_modules | grep -v ".git" | head -5; then
          echo "âš ï¸ WARNING: Potential hardcoded secrets found - review above"
        fi
        
        echo "âœ… Security scan completed"